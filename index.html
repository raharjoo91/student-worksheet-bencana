<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Lembar Kerja Siswa - Perencanaan Situs Rumah Sakit Lapangan Darurat">
  <title>Lembar Kerja Siswa - Rumah Sakit Lapangan Darurat</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --primary: #2563eb;
      --primary-dark: #1e40af;
      --primary-light: #3b82f6;
      --secondary: #10b981;
      --accent: #f59e0b;
      --text: #1f2937;
      --text-light: #6b7280;
      --bg-primary: #ffffff;
      --bg-secondary: #f9fafb;
      --bg-tertiary: #f3f4f6;
      --border: #e5e7eb;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
      --spacing-sm: 1rem;
      --spacing-md: 1.5rem;
      --spacing-lg: 2rem;
      --spacing-xl: 3rem;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      line-height: 1.7;
      color: var(--text);
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      padding: var(--spacing-md);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: var(--bg-primary);
      padding: var(--spacing-xl);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-lg);
    }

    header {
      text-align: center;
      margin-bottom: var(--spacing-xl);
      padding-bottom: var(--spacing-lg);
      border-bottom: 3px solid var(--primary);
    }

    h1 {
      color: var(--primary);
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: var(--spacing-sm);
    }

    .subtitle {
      color: var(--text-light);
      font-size: 1rem;
    }

    h2 {
      color: var(--primary);
      font-size: 1.5rem;
      font-weight: 600;
      margin-top: var(--spacing-lg);
      margin-bottom: var(--spacing-md);
      padding-bottom: var(--spacing-sm);
      border-bottom: 2px solid var(--border);
    }

    h3 {
      color: var(--primary-dark);
      font-size: 1.125rem;
      font-weight: 600;
      margin-top: var(--spacing-md);
      margin-bottom: var(--spacing-sm);
    }

    .section {
      margin-bottom: var(--spacing-lg);
    }

    .info-box {
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      padding: var(--spacing-md);
      border-left: 4px solid var(--primary);
      border-radius: var(--radius-md);
      margin: var(--spacing-md) 0;
    }

    .warning-box {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      padding: var(--spacing-md);
      border-left: 4px solid var(--warning);
      border-radius: var(--radius-md);
      margin: var(--spacing-md) 0;
    }

    .scenario-card {
      background: var(--bg-secondary);
      padding: var(--spacing-md);
      border-radius: var(--radius-lg);
      margin: var(--spacing-md) 0;
      border-left: 5px solid;
      box-shadow: var(--shadow-md);
      transition: transform 0.2s ease;
      cursor: pointer;
    }

    .scenario-card:hover {
      transform: translateX(4px);
    }

    .scenario-card.selected {
      box-shadow: 0 0 0 3px var(--primary);
    }

    .scenario-a { border-left-color: #3b82f6; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); }
    .scenario-b { border-left-color: #10b981; background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); }
    .scenario-c { border-left-color: #f59e0b; background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); }

    .badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
      margin-left: var(--spacing-sm);
    }

    .badge-type-1 { background: #3b82f6; color: white; }
    .badge-type-2 { background: #10b981; color: white; }
    .badge-type-3 { background: #f59e0b; color: white; }

    .checklist {
      list-style: none;
      padding: 0;
    }

    .checklist li {
      padding: var(--spacing-sm);
      margin: var(--spacing-xs) 0;
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      display: flex;
      align-items: flex-start;
      gap: var(--spacing-sm);
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .checklist li:hover {
      background: #e5e7eb;
    }

    .checklist li.checked {
      background: #d1fae5;
    }

    .checklist li::before {
      content: '‚òê';
      font-size: 1.25rem;
      color: var(--primary);
      flex-shrink: 0;
    }

    .checklist li.checked::before {
      content: '‚òë';
      color: var(--success);
    }

    .input-section {
      background: var(--bg-secondary);
      padding: var(--spacing-md);
      border-radius: var(--radius-md);
      margin: var(--spacing-sm) 0;
    }

    .input-section label {
      display: block;
      font-weight: 600;
      margin-bottom: var(--spacing-xs);
    }

    .input-section input, .input-section textarea, .input-section select {
      width: 100%;
      padding: var(--spacing-sm);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-family: inherit;
    }

    .timer {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--primary);
      color: white;
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--radius-lg);
      font-weight: 700;
      font-size: 1.25rem;
      box-shadow: var(--shadow-lg);
      z-index: 100;
    }

    /* Drag and Drop Canvas Section */
    .drawing-section {
      background: var(--bg-secondary);
      padding: var(--spacing-md);
      border-radius: var(--radius-lg);
      margin: var(--spacing-lg) 0;
    }

    .canvas-workspace {
      display: flex;
      gap: var(--spacing-md);
    }

    .zone-palette {
      width: 200px;
      background: white;
      border-radius: var(--radius-md);
      padding: var(--spacing-sm);
      border: 2px solid var(--border);
      max-height: 650px;
      overflow-y: auto;
      flex-shrink: 0;
    }

    .palette-title {
      font-weight: 700;
      font-size: 0.875rem;
      color: var(--primary-dark);
      text-align: center;
      padding-bottom: var(--spacing-sm);
      border-bottom: 1px solid var(--border);
      margin-bottom: var(--spacing-sm);
    }

    .palette-items {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
    }

    .palette-item {
      background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
      color: white;
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--radius-md);
      font-size: 0.75rem;
      cursor: grab;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      user-select: none;
    }

    .palette-item:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-md);
    }

    .palette-item:active {
      cursor: grabbing;
    }

    .palette-item .zone-code {
      background: rgba(255,255,255,0.3);
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.7rem;
      flex-shrink: 0;
    }

    .canvas-container {
      flex: 1;
      position: relative;
      background: white;
      border: 2px solid var(--border);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    #drawingCanvas {
      display: block;
      cursor: crosshair;
      background: white;
    }

    /* Draggable items on canvas */
    .canvas-item {
      position: absolute;
      cursor: move;
      user-select: none;
      transition: box-shadow 0.2s ease;
    }

    .canvas-item:hover {
      box-shadow: 0 0 0 2px var(--primary);
    }

    .canvas-item.selected {
      box-shadow: 0 0 0 3px var(--accent);
    }

    .canvas-item .item-content {
      background: var(--primary);
      color: white;
      padding: 0.5rem;
      border-radius: var(--radius-md);
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .canvas-item .item-controls {
      position: absolute;
      top: -30px;
      left: 50%;
      transform: translateX(-50%);
      display: none;
      gap: 0.25rem;
    }

    .canvas-item:hover .item-controls,
    .canvas-item.selected .item-controls {
      display: flex;
    }

    .item-control-btn {
      background: var(--primary);
      color: white;
      border: none;
      width: 24px;
      height: 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.7rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .item-control-btn:hover {
      background: var(--primary-dark);
    }

    .item-control-btn.delete {
      background: var(--danger);
    }

    .canvas-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-sm);
      padding: var(--spacing-sm);
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-sm);
    }

    .tool-btn {
      padding: var(--spacing-xs) var(--spacing-sm);
      border: 1px solid var(--border);
      background: white;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.2s ease;
    }

    .tool-btn:hover {
      background: var(--primary);
      color: white;
    }

    .tool-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .color-picker {
      width: 40px;
      height: 35px;
      border: 2px solid var(--border);
      border-radius: var(--radius-md);
      cursor: pointer;
    }

    .reference-layouts {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: var(--spacing-md);
      margin: var(--spacing-md) 0;
    }

    .layout-card {
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-md);
      transition: transform 0.2s ease;
    }

    .layout-card:hover {
      transform: scale(1.02);
    }

    .layout-card img {
      width: 100%;
      height: auto;
      display: block;
    }

    .layout-card .caption {
      padding: var(--spacing-sm);
      font-size: 0.875rem;
      color: var(--text);
      text-align: center;
      font-weight: 600;
    }

    .zone-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: var(--spacing-md);
      margin: var(--spacing-md) 0;
    }

    .zone-card {
      background: white;
      padding: var(--spacing-md);
      border-radius: var(--radius-md);
      border-left: 4px solid var(--primary);
      box-shadow: var(--shadow-sm);
    }

    .zone-card .code {
      font-weight: 700;
      color: var(--primary);
      font-size: 1.25rem;
    }

    .zone-card .name {
      font-weight: 600;
      margin-top: var(--spacing-xs);
      font-size: 0.9rem;
    }

    .action-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-sm);
      margin: var(--spacing-lg) 0;
      justify-content: center;
    }

    .btn {
      padding: var(--spacing-sm) var(--spacing-md);
      border: none;
      border-radius: var(--radius-md);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      background: #059669;
      transform: translateY(-2px);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .help-tip {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      padding: var(--spacing-sm);
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      margin-top: var(--spacing-sm);
      border-left: 4px solid var(--warning);
    }

    .help-tip strong {
      display: block;
      margin-bottom: 0.25rem;
    }

    @media (max-width: 768px) {
      body { padding: var(--spacing-sm); }
      .container { padding: var(--spacing-md); }
      h1 { font-size: 1.5rem; }
      .timer { font-size: 1rem; padding: var(--spacing-xs) var(--spacing-sm); }
      .canvas-workspace { flex-direction: column; }
      .zone-palette { width: 100%; max-height: 150px; }
      .palette-items { flex-direction: row; flex-wrap: wrap; }
    }

    @media print {
      body { background: white; padding: 0; }
      .container { box-shadow: none; }
      .timer, .canvas-toolbar, .action-buttons, .item-controls { display: none; }
    }
  </style>
</head>
<body>
  <div class="timer" id="timer">00:00</div>

  <div class="container" id="mainContent">
    <header>
      <h1>Lembar Kerja Siswa</h1>
      <p class="subtitle">Perencanaan Situs Rumah Sakit Lapangan Darurat</p>
    </header>

    <!-- INFO TIM -->
    <div class="section">
      <h2>Informasi Tim</h2>
      <div class="input-section">
        <label>Nama Tim:</label>
        <input type="text" id="teamName" placeholder="Masukkan nama tim">
      </div>
      <div class="input-section">
        <label>Anggota Tim:</label>
        <textarea id="teamMembers" rows="3" placeholder="Daftar semua anggota tim"></textarea>
      </div>
      <div class="input-section">
        <label>Skenario yang Dipilih:</label>
        <select id="scenarioSelect">
          <option value="">-- Pilih skenario Anda --</option>
          <option value="A">Skenario A: Gempa Bumi Remote (Tipe 1)</option>
          <option value="B">Skenario B: Banjir Urban + Kolera (Tipe 2)</option>
          <option value="C">Skenario C: Erupsi Vulkanik & Pengungsian Massal (Tipe 3)</option>
        </select>
      </div>
    </div>

    <!-- TUJUAN PEMBELAJARAN -->
    <div class="section">
      <h2>Tujuan Pembelajaran</h2>
      <div class="info-box">
        <p>Pada akhir latihan ini, Anda akan mampu:</p>
        <ol style="margin-left: var(--spacing-lg); margin-top: var(--spacing-sm);">
          <li>Mendesain tata letak situs 2D yang sesuai standar untuk rumah sakit lapangan darurat</li>
          <li>Menerapkan standar teknis minimum untuk zona fungsional, WASH, dan buffer keamanan</li>
          <li>Mengintegrasikan layanan esensial: komando, kesehatan reproduksi, dan dukungan kesehatan mental</li>
        </ol>
      </div>
    </div>

    <!-- SKENARIO -->
    <div class="section">
      <h2>Pilih Skenario Anda</h2>
      <p style="margin-bottom: var(--spacing-sm);"><em>Klik pada skenario untuk memilih</em></p>

      <div class="scenario-card scenario-a" onclick="selectScenario('A', this)">
        <h3>Skenario A: Gempa Bumi Remote <span class="badge badge-type-1">Tipe 1</span></h3>
        <p><strong>Konteks:</strong> Gempa 7.0 SR di wilayah pegunungan. Jalan rusak. Tidak ada listrik atau bangunan.</p>
        <p><strong>Fokus:</strong> Perawatan rawat jalan, manajemen luka, pemeriksaan maternal, pengisian obat penyakit kronis.</p>
        <p><strong>Situs:</strong> Lapangan datar (80m √ó 60m). Sepenuhnya menggunakan tenda.</p>
        <p><strong>Kapasitas:</strong> 20‚Äì50 tempat tidur</p>
      </div>

      <div class="scenario-card scenario-b" onclick="selectScenario('B', this)">
        <h3>Skenario B: Banjir Urban + Wabah Kolera <span class="badge badge-type-2">Tipe 2</span></h3>
        <p><strong>Konteks:</strong> Banjir muson mengungsikan 20.000 jiwa di kawasan urban berpendapatan rendah. Genangan air, sanitasi buruk.</p>
        <p><strong>Fokus:</strong> Perawatan rawat inap rehidrasi, kontrol infeksi, bedah darurat, diagnostik lab, kesehatan reproduksi & mental.</p>
        <p><strong>Situs:</strong> Tanah sekolah yang lebih tinggi (120m √ó 100m). Sebagian permukaan keras tersedia.</p>
        <p><strong>Kapasitas:</strong> 50‚Äì100 tempat tidur</p>
      </div>

      <div class="scenario-card scenario-c" onclick="selectScenario('C', this)">
        <h3>Skenario C: Erupsi Vulkanik & Pengungsian Massal <span class="badge badge-type-3">Tipe 3</span></h3>
        <p><strong>Konteks:</strong> Erupsi besar memaksa 50.000+ jiwa mengungsi. Abu vulkanik mengganggu air, listrik, dan layanan kesehatan.</p>
        <p><strong>Fokus:</strong> Suite bedah lengkap, ICU, perawatan respirasi, kesehatan mental, telemedisin, pelatihan, kesehatan reproduksi.</p>
        <p><strong>Situs:</strong> Area evakuasi besar (150m √ó 120m). Konstruksi hibrida dengan bangunan permanen bila tersedia.</p>
        <p><strong>Kapasitas:</strong> 100‚Äì200+ tempat tidur</p>
      </div>
    </div>

    <!-- ZONA YANG DIBUTUHKAN -->
    <div class="section">
      <h2>Zona Fungsional yang Diperlukan</h2>
      <p>Gunakan panduan ini saat merencanakan tata letak Anda. Semua zona harus disertakan.</p>

      <div class="zone-grid">
        <div class="zone-card">
          <div class="code">1</div>
          <div class="name">Komando & Admin</div>
        </div>
        <div class="zone-card">
          <div class="code">2</div>
          <div class="name">Rawat Inap Pria</div>
        </div>
        <div class="zone-card">
          <div class="code">3</div>
          <div class="name">Rawat Inap Wanita</div>
        </div>
        <div class="zone-card">
          <div class="code">4</div>
          <div class="name">Rawat Jalan (OPD)</div>
          <div style="font-size: 0.75rem; color: var(--text-light);">+ Kesehatan Reproduksi</div>
        </div>
        <div class="zone-card">
          <div class="code">5</div>
          <div class="name">ICU</div>
        </div>
        <div class="zone-card">
          <div class="code">6</div>
          <div class="name">IGD (UGD)</div>
        </div>
        <div class="zone-card">
          <div class="code">7</div>
          <div class="name">Akomodasi Staf</div>
        </div>
        <div class="zone-card">
          <div class="code">8</div>
          <div class="name">Ruang Operasi</div>
        </div>
        <div class="zone-card">
          <div class="code">9</div>
          <div class="name">CSSD</div>
          <div style="font-size: 0.75rem; color: var(--text-light);">Sterilisasi</div>
        </div>
        <div class="zone-card">
          <div class="code">10</div>
          <div class="name">Farmasi</div>
        </div>
        <div class="zone-card">
          <div class="code">11</div>
          <div class="name">Toilet Staf</div>
        </div>
        <div class="zone-card">
          <div class="code">12</div>
          <div class="name">X-Ray</div>
        </div>
        <div class="zone-card">
          <div class="code">13</div>
          <div class="name">Toilet Pasien/WC</div>
        </div>
        <div class="zone-card">
          <div class="code">14</div>
          <div class="name">Purifikasi Air</div>
        </div>
        <div class="zone-card">
          <div class="code">15</div>
          <div class="name">Tangki Air Utama</div>
        </div>
        <div class="zone-card">
          <div class="code">16</div>
          <div class="name">Dapur</div>
        </div>
        <div class="zone-card">
          <div class="code">17</div>
          <div class="name">Gudang Logistik</div>
        </div>
        <div class="zone-card">
          <div class="code">18</div>
          <div class="name">Genset</div>
        </div>
        <div class="zone-card">
          <div class="code">19</div>
          <div class="name">Keamanan/Bendera</div>
        </div>
        <div class="zone-card">
          <div class="code">‚Äî</div>
          <div class="name">Unit MHPSS</div>
          <div style="font-size: 0.75rem; color: var(--text-light);">Kesehatan Mental (Tipe 2/3)</div>
        </div>
        <div class="zone-card">
          <div class="code">üî¥</div>
          <div class="name">EMTT Coordination Cell</div>
          <div style="font-size: 0.75rem; color: var(--text-light);">Koordinasi Tim Medis Darurat</div>
        </div>
        <div class="zone-card">
          <div class="code">üü†</div>
          <div class="name">Health Emergency Operational Center</div>
          <div style="font-size: 0.75rem; color: var(--text-light);">Pusat Operasional Kedaruratan Kesehatan</div>
        </div>
      </div>
    </div>

    <!-- DAFTAR PERIKSA DESAIN -->
    <div class="section">
      <h2>Daftar Periksa Perencanaan Situs</h2>
      <ul class="checklist">
        <li onclick="toggleCheck(this)">Batas situs dengan dimensi ditandai</li>
        <li onclick="toggleCheck(this)">Enam zona fungsional teridentifikasi (Klinis, Dukungan, Logistik, Administrasi, Staf, Keamanan)</li>
        <li onclick="toggleCheck(this)">Titik masuk pasien di bagian depan</li>
        <li onclick="toggleCheck(this)">Area ambulance dapat diakses</li>
        <li onclick="toggleCheck(this)">Tenda klinis dengan kapasitas tempat tidur ditandai</li>
        <li onclick="toggleCheck(this)">Tangki air (15) + purifikasi (14) diposisikan bersama</li>
        <li onclick="toggleCheck(this)">Fasilitas sanitasi (13, 11) ‚â•30m dari sumber air</li>
        <li onclick="toggleCheck(this)">Area limbah medis ‚â•500m dari populasi</li>
        <li onclick="toggleCheck(this)">Koridor utilitas untuk pergerakan</li>
        <li onclick="toggleCheck(this)">Akomodasi staf dengan WASH terpisah</li>
        <li onclick="toggleCheck(this)">Pintu keluar darurat ditandai</li>
        <li onclick="toggleCheck(this)">Area parkir/loading dapat diakses</li>
        <li onclick="toggleCheck(this)">Perimeter keamanan dengan bendera (19)</li>
        <li onclick="toggleCheck(this)">Unit MHPSS disertakan (Tipe 2/3 saja)</li>
        <li onclick="toggleCheck(this)">Kesehatan reproduksi terintegrasi (Tipe 2/3 saja)</li>
      </ul>
    </div>

    <!-- ATURAN KEAMANAN KRITIS -->
    <div class="section">
      <h2>Aturan Keamanan Kritis</h2>
      <div class="warning-box">
        <h3>Persyaratan WASH</h3>
        <ul>
          <li>Sanitasi (toilet) harus ‚â•30 meter dari sumber air</li>
          <li>Fasilitas WASH staf dan pasien harus terpisah</li>
          <li>Area limbah medis harus ‚â•500 meter dari pusat populasi</li>
        </ul>
      </div>
      <div class="warning-box">
        <h3>Prinsip Zonasi</h3>
        <ul>
          <li>Zona klinis harus terpisah dari logistik/dukungan</li>
          <li>IGD harus dekat dengan pintu masuk</li>
          <li>Area isolasi untuk kasus infeksi (bila berlaku)</li>
          <li>Genset menjauh dari area pasien karena suara/gas</li>
        </ul>
      </div>
    </div>

    <!-- REFERENSI TATA LETAK -->
    <div class="section">
      <h2>Referensi Tata Letak</h2>
      <p>Contoh tata letak rumah sakit lapangan untuk referensi perencanaan Anda:</p>

      <div class="reference-layouts">
        <div class="layout-card">
          <img src="REFERENCE%20LAYOUT/Layout%201.png" alt="Layout Referensi 1">
          <div class="caption">Layout Referensi 1</div>
        </div>
        <div class="layout-card">
          <img src="REFERENCE%20LAYOUT/Layout%202.png" alt="Layout Referensi 2">
          <div class="caption">Layout Referensi 2</div>
        </div>
        <div class="layout-card">
          <img src="REFERENCE%20LAYOUT/Layout%203.png" alt="Layout Referensi 3">
          <div class="caption">Layout Referensi 3</div>
        </div>
        <div class="layout-card">
          <img src="REFERENCE%20LAYOUT/Layout%204.png" alt="Layout Referensi 4">
          <div class="caption">Layout Referensi 4</div>
        </div>
        <div class="layout-card">
          <img src="REFERENCE%20LAYOUT/Layout%205.png" alt="Layout Referensi 5">
          <div class="caption">Layout Referensi 5</div>
        </div>
        <div class="layout-card">
          <img src="REFERENCE%20LAYOUT/Layout%206.png" alt="Layout Referensi 6">
          <div class="caption">Layout Referensi 6</div>
        </div>
      </div>
    </div>

    <!-- AREA DESAIN DENGAN DRAG & DROP -->
    <div class="section">
      <h2>Area Desain Situs - Drag & Drop</h2>
      <p><strong>üéØ Cara menggunakan:</strong> Tarik zona dari panel kiri dan lepas di kanvas. Klik item untuk memindahkan, gunakan tombol kontrol untuk menghapus.</p>

      <div class="help-tip">
        <strong>üí° Tips:</strong>
        ‚Ä¢ <strong>Drag & Drop:</strong> Tarik zona dari panel kiri ke kanvas<br>
        ‚Ä¢ <strong>Move:</strong> Klik dan seret item yang sudah ditempatkan<br>
        ‚Ä¢ <strong>Delete:</strong> Klik tombol ‚ùå pada item<br>
        ‚Ä¢ <strong>Undo:</strong> Klik tombol ‚Ü∂ Undo untuk mengembalikan<br>
        ‚Ä¢ <strong>Konteks Situs:</strong> Perhatikan pemukiman, sungai, jalan dll. di kanvas saat menempatkan zona
      </div>

      <div class="warning-box" style="margin-top: var(--spacing-sm);">
        <strong>‚ö†Ô∏è Pertimbangan Penempatan:</strong>
        ‚Ä¢ Toilet/WC ‚â•30m dari sungai/sumur<br>
        ‚Ä¢ Limbah medis ‚â•500m dari pemukiman<br>
        ‚Ä¢ Genset menjauh dari jaringan listrik<br>
        ‚Ä¢ IGD dekat jalan untuk akses ambulance
      </div>

      <div class="drawing-section">
        <div class="canvas-workspace">
          <!-- Zone Palette - Left Side -->
          <div class="zone-palette">
            <div class="palette-title">üìç ZONA Fungsional</div>
            <div class="palette-items" id="paletteItems">
              <div class="palette-item" draggable="true" data-zone="1" data-name="Komando & Admin">
                <span class="zone-code">1</span>
                <span>Komando</span>
              </div>
              <div class="palette-item" draggable="true" data-zone="2" data-name="Rawat Inap Pria">
                <span class="zone-code">2</span>
                <span>Rawat Pria</span>
              </div>
              <div class="palette-item" draggable="true" data-zone="3" data-name="Rawat Inap Wanita">
                <span class="zone-code">3</span>
                <span>Rawat Wanita</span>
              </div>
              <div class="palette-item" draggable="true" data-zone="4" data-name="Rawat Jalan (OPD)">
                <span class="zone-code">4</span>
                <span>OPD</span>
              </div>
              <div class="palette-item" draggable="true" data-zone="5" data-name="ICU">
                <span class="zone-code">5</span>
                <span>ICU</span>
              </div>
              <div class="palette-item" draggable="true" data-zone="6" data-name="IGD">
                <span class="zone-code">6</span>
                <span>IGD</span>
              </div>
              <div class="palette-item" draggable="true" data-zone="7" data-name="Akomodasi Staf">
                <span class="zone-code">7</span>
                <span>Staf</span>
              </div>
              <div class="palette-item" draggable="true" data-zone="8" data-name="Ruang Operasi">
                <span class="zone-code">8</span>
                <span>OK</span>
              </div>
              <div class="palette-item" draggable="true" data-zone="9" data-name="CSSD">
                <span class="zone-code">9</span>
                <span>CSSD</span>
              </div>
              <div class="palette-item" draggable="true" data-zone="10" data-name="Farmasi">
                <span class="zone-code">10</span>
                <span>Farmasi</span>
              </div>
              <div class="palette-item" draggable="true" data-zone="11" data-name="Toilet Staf">
                <span class="zone-code">11</span>
                <span>WC Staf</span>
              </div>
              <div class="palette-item" draggable="true" data-zone="12" data-name="X-Ray">
                <span class="zone-code">12</span>
                <span>X-Ray</span>
              </div>
              <div class="palette-item" draggable="true" data-zone="13" data-name="Toilet Pasien">
                <span class="zone-code">13</span>
                <span>WC Pasien</span>
              </div>
              <div class="palette-item" draggable="true" data-zone="14" data-name="Purifikasi Air">
                <span class="zone-code">14</span>
                <span>Purifikasi</span>
              </div>
              <div class="palette-item" draggable="true" data-zone="15" data-name="Tangki Air">
                <span class="zone-code">15</span>
                <span>Tangki Air</span>
              </div>
              <div class="palette-item" draggable="true" data-zone="16" data-name="Dapur">
                <span class="zone-code">16</span>
                <span>Dapur</span>
              </div>
              <div class="palette-item" draggable="true" data-zone="17" data-name="Gudang Logistik">
                <span class="zone-code">17</span>
                <span>Gudang</span>
              </div>
              <div class="palette-item" draggable="true" data-zone="18" data-name="Genset">
                <span class="zone-code">18</span>
                <span>Genset</span>
              </div>
              <div class="palette-item" draggable="true" data-zone="19" data-name="Keamanan">
                <span class="zone-code">19</span>
                <span>Keamanan</span>
              </div>
              <div class="palette-item" draggable="true" data-zone="20" data-name="MHPSS" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                <span class="zone-code">‚Äî</span>
                <span>MHPSS</span>
              </div>
              <div class="palette-item" draggable="true" data-zone="21" data-name="EMTT Coordation Cell" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                <span class="zone-code">üî¥</span>
                <span>EMTT Coord</span>
              </div>
              <div class="palette-item" draggable="true" data-zone="22" data-name="Health Emergency Operational Center" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);">
                <span class="zone-code">üü†</span>
                <span>HEOF</span>
              </div>
            </div>

            <!-- Toolbar buttons at bottom of palette -->
            <div style="margin-top: var(--spacing-sm); padding-top: var(--spacing-sm); border-top: 1px solid var(--border);">
              <button class="tool-btn" onclick="undoLastAction()" title="Undo" style="width: 100%; margin-bottom: 0.25rem;">‚Ü∂ Undo</button>
              <button class="tool-btn" onclick="clearAllItems()" title="Hapus Semua" style="width: 100%; margin-bottom: 0.25rem;">üóëÔ∏è Hapus Semua</button>
              <button class="tool-btn" onclick="toggleGrid()" title="Toggle Grid" style="width: 100%; margin-bottom: 0.25rem;">üìè Toggle Grid</button>
              <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; margin-top: 0.5rem;">
                <input type="checkbox" id="snapToGrid" checked style="width: 14px; height: 14px;">
                Snap to Grid
              </label>
            </div>
          </div>

          <!-- Canvas - Right Side -->
          <div class="canvas-container" id="canvasContainer">
            <canvas id="drawingCanvas" width="900" height="600"></canvas>
            <div id="itemsLayer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- EVALUASI DIRI -->
    <div class="section">
      <h2>Evaluasi Diri</h2>
      <p>Sebelum menyerahkan desain Anda, tinjau terhadap pertanyaan-pertanyaan ini:</p>
      <ul class="checklist">
        <li onclick="toggleCheck(this)">Apakah Komando/Admin (Zona 1) diposisikan secara sentral untuk koordinasi?</li>
        <li onclick="toggleCheck(this)">Apakah fasilitas WASH pasien dan staf terpisah dan ‚â•30m dari air?</li>
        <li onclick="toggleCheck(this)">Apakah kesehatan reproduksi terintegrasi dalam skenario Tipe 2/3?</li>
        <li onclick="toggleCheck(this)">Apakah MHPSS disertakan untuk skenario Tipe 2/3?</li>
        <li onclick="toggleCheck(this)">Apakah limbah medis dan genset ditempatkan dengan aman menjauh dari area berpenduduk?</li>
        <li onclick="toggleCheck(this)">Apakah alur pasien logis dari masuk ke triase ke pengobatan?</li>
        <li onclick="toggleCheck(this)">Apakah pintu keluar darurat ditandai dengan jelas?</li>
        <li onclick="toggleCheck(this)">Apakah area ambulance dapat diakses tanpa melintasi area pasien?</li>
      </ul>
    </div>

    <!-- CATATAN TIM -->
    <div class="section">
      <h2>Catatan Tim</h2>
      <div class="input-section">
        <label>Catatan tambahan, tantangan, atau keputusan yang dibuat:</label>
        <textarea id="teamNotes" rows="5" placeholder="Dokumentasikan keputusan desain dan rasional tim Anda..."></textarea>
      </div>
    </div>

    <!-- TOMBOL AKSI -->
    <div class="action-buttons">
      <button class="btn btn-primary" onclick="saveToLocalStorage()">
        üíæ Simpan Secara Lokal
      </button>
      <button class="btn btn-success" onclick="exportAsPDF()">
        üìÑ Ekspor sebagai PDF
      </button>
      <button class="btn btn-primary" onclick="downloadAsImage()">
        üñºÔ∏è Download Gambar Desain
      </button>
      <button class="btn btn-primary" onclick="sendToGoogleDrive()">
        üì§ Kirim ke Google Drive
      </button>
      <button class="btn btn-danger" onclick="clearAllData()">
        üóëÔ∏è Hapus Semua Data
      </button>
    </div>

    <div style="text-align: center; margin-top: var(--spacing-xl); padding-top: var(--spacing-lg); border-top: 2px solid var(--border); color: var(--text-light); font-size: 0.875rem;">
      <p>Perencanaan Situs Rumah Sakit Lapangan Darurat - Lembar Kerja Siswa</p>
      <p><strong>Manajemen Bencana - 2025/2026 Genap</strong></p>
      <p>UNTUK KEGIATAN PELATIHAN SAJA</p>
    </div>
  </div>

  <script>
    // Timer functionality
    let seconds = 0;
    let timerInterval;

    function formatTime(sec) {
      const mins = Math.floor(sec / 60);
      const secs = sec % 60;
      return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    function updateTimer() {
      seconds++;
      document.getElementById('timer').textContent = formatTime(seconds);
    }

    timerInterval = setInterval(updateTimer, 1000);

    // Scenario selection
    let selectedScenario = '';

    function selectScenario(scenario, element) {
      selectedScenario = scenario;
      document.querySelectorAll('.scenario-card').forEach(card => card.classList.remove('selected'));
      element.classList.add('selected');
      document.getElementById('scenarioSelect').value = scenario;
      saveToLocalStorage();
    }

    // Checklist toggle
    function toggleCheck(element) {
      element.classList.toggle('checked');
      saveToLocalStorage();
    }

    // Canvas and Drag & Drop functionality
    const canvas = document.getElementById('drawingCanvas');
    const ctx = canvas.getContext('2d');
    const canvasContainer = document.getElementById('canvasContainer');
    const itemsLayer = document.getElementById('itemsLayer');

    let showGrid = true;
    let placedItems = [];
    let actionHistory = [];
    let itemIdCounter = 0;

    // Grid size for snapping
    const GRID_SIZE = 20;

    // Draw grid with site context elements
    function drawGrid() {
      if (!showGrid) {
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        drawSiteContext();
        return;
      }

      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Draw site context first (background layer)
      drawSiteContext();

      // Draw grid lines on top
      ctx.strokeStyle = '#e5e7eb';
      ctx.lineWidth = 1;

      for (let x = 0; x <= canvas.width; x += GRID_SIZE) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
      }

      for (let y = 0; y <= canvas.height; y += GRID_SIZE) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
        ctx.stroke();
      }

      // Draw site boundary indicator
      ctx.strokeStyle = '#2563eb';
      ctx.lineWidth = 3;
      ctx.strokeRect(10, 10, canvas.width - 20, canvas.height - 20);
    }

    // Draw site context elements (like a map background)
    function drawSiteContext() {
      // Road at the top (main access road)
      ctx.fillStyle = '#6b7280';
      ctx.fillRect(0, 0, canvas.width, 40);
      // Road markings
      ctx.strokeStyle = '#fbbf24';
      ctx.lineWidth = 2;
      ctx.setLineDash([20, 10]);
      ctx.beginPath();
      ctx.moveTo(0, 20);
      ctx.lineTo(canvas.width, 20);
      ctx.stroke();
      ctx.setLineDash([]);

      // Housing area on the left (existing settlement)
      ctx.fillStyle = 'rgba(251, 191, 36, 0.3)';
      ctx.fillRect(10, 60, 150, 120);
      ctx.strokeStyle = '#f59e0b';
      ctx.lineWidth = 2;
      ctx.strokeRect(10, 60, 150, 120);
      // Label
      ctx.fillStyle = '#92400e';
      ctx.font = 'bold 11px Arial';
      ctx.fillText('üè† Pemukiman', 20, 80);

      // River at the bottom right
      ctx.fillStyle = 'rgba(14, 165, 233, 0.4)';
      ctx.beginPath();
      ctx.moveTo(500, canvas.height - 60);
      ctx.quadraticCurveTo(600, canvas.height - 100, 700, canvas.height - 60);
      ctx.quadraticCurveTo(800, canvas.height - 20, 900, canvas.height - 60);
      ctx.lineTo(900, canvas.height);
      ctx.lineTo(500, canvas.height);
      ctx.closePath();
      ctx.fill();
      ctx.strokeStyle = '#0284c7';
      ctx.lineWidth = 2;
      ctx.stroke();
      // Label
      ctx.fillStyle = '#0c4a6e';
      ctx.fillText('üåä Sungai', 520, canvas.height - 50);

      // Well (water source) on the right
      ctx.fillStyle = '#06b6d4';
      ctx.beginPath();
      ctx.arc(canvas.width - 80, 150, 25, 0, Math.PI * 2);
      ctx.fill();
      ctx.strokeStyle = '#0891b2';
      ctx.lineWidth = 2;
      ctx.stroke();
      // Label
      ctx.fillStyle = '#164e63';
      ctx.fillText('üíß Sumur', canvas.width - 100, 195);

      // Existing building (school) on the right
      ctx.fillStyle = 'rgba(168, 162, 158, 0.4)';
      ctx.fillRect(canvas.width - 180, 200, 160, 100);
      ctx.strokeStyle = '#78716c';
      ctx.lineWidth = 2;
      ctx.strokeRect(canvas.width - 180, 200, 160, 100);
      // Label
      ctx.fillStyle = '#44403c';
      ctx.fillText('üè¢ Gedung Sekolah', canvas.width - 170, 220);

      // Green area/trees on the bottom left
      ctx.fillStyle = 'rgba(34, 197, 94, 0.2)';
      ctx.beginPath();
      ctx.arc(80, canvas.height - 80, 60, 0, Math.PI * 2);
      ctx.fill();
      ctx.strokeStyle = '#16a34a';
      ctx.lineWidth = 2;
      ctx.stroke();
      // Label
      ctx.fillStyle = '#14532d';
      ctx.fillText('üå≥ Area Hijau', 45, canvas.height - 75);

      // Power lines along the top road
      ctx.strokeStyle = '#fbbf24';
      ctx.lineWidth = 2;
      for (let x = 100; x < canvas.width; x += 200) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, 80);
        ctx.stroke();
        // Power pole
        ctx.fillStyle = '#78716c';
        ctx.fillRect(x - 3, 40, 6, 40);
      }
      ctx.fillStyle = '#92400e';
      ctx.fillText('‚ö° Jaringan Listrik', 120, 35);

      // Helipad area on the far right
      ctx.fillStyle = 'rgba(239, 68, 68, 0.2)';
      ctx.beginPath();
      ctx.ellipse(canvas.width - 60, 350, 50, 50, 0, 0, Math.PI * 2);
      ctx.fill();
      ctx.strokeStyle = '#dc2626';
      ctx.lineWidth = 2;
      ctx.stroke();
      // Cross marking
      ctx.beginPath();
      ctx.moveTo(canvas.width - 110, 350);
      ctx.lineTo(canvas.width - 10, 350);
      ctx.moveTo(canvas.width - 60, 300);
      ctx.lineTo(canvas.width - 60, 400);
      ctx.stroke();
      // Label
      ctx.fillStyle = '#7f1d1d';
      ctx.fillText('üöÅ Helipad', canvas.width - 85, 420);

      // Waste area indicator (far from housing)
      ctx.fillStyle = 'rgba(127, 29, 29, 0.2)';
      ctx.fillRect(canvas.width - 120, canvas.height - 120, 100, 80);
      ctx.strokeStyle = '#7f1d1d';
      ctx.lineWidth = 2;
      ctx.setLineDash([5, 5]);
      ctx.strokeRect(canvas.width - 120, canvas.height - 120, 100, 80);
      ctx.setLineDash([]);
      // Label
      ctx.fillStyle = '#7f1d1d';
      ctx.fillText('‚ò¢Ô∏è Area Limbah', canvas.width - 115, canvas.height - 100);

      // Legend/Distance indicators
      ctx.fillStyle = '#374151';
      ctx.font = '10px Arial';
      ctx.fillText('Skala: 20px = 10 meter', 15, canvas.height - 10);
    }

    drawGrid();

    // Toggle grid
    function toggleGrid() {
      showGrid = !showGrid;
      drawGrid();
    }

    // Snap to grid function
    function snapToGridValue(value) {
      if (!document.getElementById('snapToGrid').checked) return value;
      return Math.round(value / GRID_SIZE) * GRID_SIZE;
    }

    // Palette drag events
    const paletteItems = document.querySelectorAll('.palette-item');

    paletteItems.forEach(item => {
      item.addEventListener('dragstart', handleDragStart);
      item.addEventListener('dragend', handleDragEnd);
    });

    // Canvas drop events
    canvasContainer.addEventListener('dragover', handleDragOver);
    canvasContainer.addEventListener('drop', handleDrop);
    canvasContainer.addEventListener('dragleave', handleDragLeave);

    let draggedZone = null;

    function handleDragStart(e) {
      draggedZone = {
        zone: e.target.dataset.zone,
        name: e.target.dataset.name
      };
      e.target.style.opacity = '0.5';
      e.dataTransfer.effectAllowed = 'copy';
    }

    function handleDragEnd(e) {
      e.target.style.opacity = '1';
    }

    function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'copy';
      canvasContainer.style.borderColor = '#2563eb';
    }

    function handleDragLeave(e) {
      canvasContainer.style.borderColor = '#e5e7eb';
    }

    function handleDrop(e) {
      e.preventDefault();
      canvasContainer.style.borderColor = '#e5e7eb';

      if (!draggedZone) return;

      const rect = canvasContainer.getBoundingClientRect();
      const x = snapToGridValue(e.clientX - rect.left);
      const y = snapToGridValue(e.clientY - rect.top);

      addCanvasItem(draggedZone.zone, draggedZone.name, x, y);
      draggedZone = null;
    }

    // Add item to canvas
    function addCanvasItem(zone, name, x, y) {
      // Save state for undo
      saveAction();

      const itemId = `item-${itemIdCounter++}`;

      const item = {
        id: itemId,
        zone: zone,
        name: name,
        x: x,
        y: y
      };

      placedItems.push(item);
      renderCanvasItem(item);
      saveToLocalStorage();
    }

    // Render item on canvas
    function renderCanvasItem(item) {
      const existingElement = document.getElementById(item.id);
      if (existingElement) {
        existingElement.remove();
      }

      const itemElement = document.createElement('div');
      itemElement.id = item.id;
      itemElement.className = 'canvas-item';
      itemElement.style.left = item.x + 'px';
      itemElement.style.top = item.y + 'px';
      itemElement.style.pointerEvents = 'auto';

      // Different colors for different zone types
      const colors = {
        '1': '#2563eb', '2': '#3b82f6', '3': '#ec4899', '4': '#10b981',
        '5': '#ef4444', '6': '#f59e0b', '7': '#8b5cf6', '8': '#dc2626',
        '9': '#7c3aed', '10': '#059669', '11': '#6366f1', '12': '#0ea5e9',
        '13': '#64748b', '14': '#06b6d4', '15': '#0284c7', '16': '#f97316',
        '17': '#78716c', '18': '#4b5563', '19': '#1f2937', '20': '#84cc16',
        '21': '#dc2626', '22': '#ea580c'
      };

      const bgColor = colors[item.zone] || '#2563eb';

      itemElement.innerHTML = `
        <div class="item-controls">
          <button class="item-control-btn delete" onclick="deleteItem('${item.id}')" title="Hapus">‚ùå</button>
        </div>
        <div class="item-content" style="background: ${bgColor}">
          <span style="background: rgba(255,255,255,0.3); width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.65rem;">${item.zone}</span>
          <span>${item.name}</span>
        </div>
      `;

      // Make item draggable within canvas
      itemElement.addEventListener('mousedown', startItemDrag);
      itemElement.addEventListener('touchstart', startItemTouchDrag, { passive: false });

      itemsLayer.appendChild(itemElement);
    }

    // Move existing item
    let movingItem = null;
    let moveOffsetX = 0;
    let moveOffsetY = 0;

    function startItemDrag(e) {
      if (e.target.classList.contains('item-control-btn')) return;

      e.preventDefault();
      movingItem = e.target.closest('.canvas-item');
      const rect = movingItem.getBoundingClientRect();
      moveOffsetX = e.clientX - rect.left;
      moveOffsetY = e.clientY - rect.top;

      document.addEventListener('mousemove', moveItem);
      document.addEventListener('mouseup', stopItemMove);
    }

    function startItemTouchDrag(e) {
      if (e.target.classList.contains('item-control-btn')) return;

      e.preventDefault();
      movingItem = e.target.closest('.canvas-item');
      const rect = movingItem.getBoundingClientRect();
      const touch = e.touches[0];
      moveOffsetX = touch.clientX - rect.left;
      moveOffsetY = touch.clientY - rect.top;

      document.addEventListener('touchmove', moveItemTouch, { passive: false });
      document.addEventListener('touchend', stopItemMove);
    }

    function moveItem(e) {
      if (!movingItem) return;

      const rect = canvasContainer.getBoundingClientRect();
      let newX = e.clientX - rect.left - moveOffsetX;
      let newY = e.clientY - rect.top - moveOffsetY;

      // Boundary check
      newX = Math.max(0, Math.min(newX, rect.width - movingItem.offsetWidth));
      newY = Math.max(0, Math.min(newY, rect.height - movingItem.offsetHeight));

      // Snap to grid
      newX = snapToGridValue(newX);
      newY = snapToGridValue(newY);

      movingItem.style.left = newX + 'px';
      movingItem.style.top = newY + 'px';
    }

    function moveItemTouch(e) {
      if (!movingItem) return;
      e.preventDefault();

      const rect = canvasContainer.getBoundingClientRect();
      const touch = e.touches[0];
      let newX = touch.clientX - rect.left - moveOffsetX;
      let newY = touch.clientY - rect.top - moveOffsetY;

      // Boundary check
      newX = Math.max(0, Math.min(newX, rect.width - movingItem.offsetWidth));
      newY = Math.max(0, Math.min(newY, rect.height - movingItem.offsetHeight));

      // Snap to grid
      newX = snapToGridValue(newX);
      newY = snapToGridValue(newY);

      movingItem.style.left = newX + 'px';
      movingItem.style.top = newY + 'px';
    }

    function stopItemMove() {
      if (movingItem) {
        // Update item position in data
        const itemId = movingItem.id;
        const item = placedItems.find(i => i.id === itemId);
        if (item) {
          item.x = parseInt(movingItem.style.left);
          item.y = parseInt(movingItem.style.top);
        }
        movingItem = null;
        saveToLocalStorage();
      }
      document.removeEventListener('mousemove', moveItem);
      document.removeEventListener('mouseup', stopItemMove);
      document.removeEventListener('touchmove', moveItemTouch);
      document.removeEventListener('touchend', stopItemMove);
    }

    // Delete item
    function deleteItem(itemId) {
      saveAction();
      const element = document.getElementById(itemId);
      if (element) {
        element.remove();
      }
      placedItems = placedItems.filter(item => item.id !== itemId);
      saveToLocalStorage();
    }

    // Clear all items
    function clearAllItems() {
      if (confirm('Apakah Anda yakin ingin menghapus semua item?')) {
        saveAction();
        itemsLayer.innerHTML = '';
        placedItems = [];
        drawGrid();
        saveToLocalStorage();
      }
    }

    // Save action for undo
    function saveAction() {
      actionHistory.push(JSON.stringify(placedItems));
      if (actionHistory.length > 20) actionHistory.shift();
    }

    // Undo last action
    function undoLastAction() {
      if (actionHistory.length > 0) {
        const previousState = JSON.parse(actionHistory.pop());
        placedItems = previousState;

        // Clear and re-render all items
        itemsLayer.innerHTML = '';
        placedItems.forEach(item => renderCanvasItem(item));
        saveToLocalStorage();
        showNotification('Undo berhasil!');
      }
    }

    // Local Storage
    function saveToLocalStorage() {
      const data = {
        teamName: document.getElementById('teamName').value,
        teamMembers: document.getElementById('teamMembers').value,
        scenario: document.getElementById('scenarioSelect').value,
        notes: document.getElementById('teamNotes').value,
        placedItems: placedItems,
        checkedItems: []
      };

      document.querySelectorAll('.checklist li.checked').forEach((item, index) => {
        data.checkedItems.push(index);
      });

      localStorage.setItem('fieldHospitalWorksheet', JSON.stringify(data));
      showNotification('Data tersimpan!');
    }

    function loadFromLocalStorage() {
      const saved = localStorage.getItem('fieldHospitalWorksheet');
      if (saved) {
        const data = JSON.parse(saved);

        document.getElementById('teamName').value = data.teamName || '';
        document.getElementById('teamMembers').value = data.teamMembers || '';
        document.getElementById('scenarioSelect').value = data.scenario || '';
        document.getElementById('teamNotes').value = data.notes || '';

        // Restore placed items
        if (data.placedItems && data.placedItems.length > 0) {
          placedItems = data.placedItems;
          let maxId = 0;
          placedItems.forEach(item => {
            const idNum = parseInt(item.id.replace('item-', ''));
            if (idNum > maxId) maxId = idNum;
            renderCanvasItem(item);
          });
          itemIdCounter = maxId + 1;
        }

        // Restore checkboxes
        const items = document.querySelectorAll('.checklist li');
        data.checkedItems.forEach(index => {
          if (items[index]) items[index].classList.add('checked');
        });
      }
    }

    // Auto-save on input
    document.querySelectorAll('input, textarea, select').forEach(input => {
      input.addEventListener('input', saveToLocalStorage);
    });

    // Clear all data
    function clearAllData() {
      if (confirm('Apakah Anda yakin ingin menghapus semua data?')) {
        localStorage.removeItem('fieldHospitalWorksheet');
        location.reload();
      }
    }

    // Export as PDF
    async function exportAsPDF() {
      showNotification('Membuat PDF...');

      const { jsPDF } = window.jspdf;
      const element = document.getElementById('mainContent');

      try {
        const canvas = await html2canvas(element, {
          scale: 2,
          useCORS: true,
          allowTaint: true,
          logging: false
        });

        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF('p', 'mm', 'a4');

        const imgWidth = 210;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;

        let heightLeft = imgHeight;
        let position = 0;

        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= 297;

        while (heightLeft > 0) {
          position = heightLeft - imgHeight;
          pdf.addPage();
          pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
          heightLeft -= 297;
        }

        const teamName = document.getElementById('teamName').value || 'Tim';
        pdf.save(`Rumah_Sakit_Lapangan_${teamName}_${new Date().toISOString().slice(0,10)}.pdf`);
        showNotification('PDF berhasil dibuat!');
      } catch (error) {
        console.error('PDF Error:', error);
        alert('Gagal membuat PDF. Silakan coba lagi atau gunakan fitur download gambar.');
      }
    }

    // Download canvas as image
    async function downloadAsImage() {
      showNotification('Membuat gambar...');

      // Create a temporary canvas that includes both the grid and items
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = canvas.width;
      tempCanvas.height = canvas.height;
      const tempCtx = tempCanvas.getContext('2d');

      // Draw the main canvas
      tempCtx.drawImage(canvas, 0, 0);

      // Draw each item
      const items = document.querySelectorAll('.canvas-item');
      items.forEach(item => {
        const x = parseInt(item.style.left);
        const y = parseInt(item.style.top);
        const content = item.querySelector('.item-content');
        const rect = content.getBoundingClientRect();

        // Draw item background
        const bgColor = content.style.background;
        tempCtx.fillStyle = bgColor;
        tempCtx.fillRect(x, y, rect.width, rect.height);

        // Draw item text
        tempCtx.fillStyle = '#ffffff';
        tempCtx.font = 'bold 12px Arial';
        const text = content.textContent.trim();
        tempCtx.fillText(text, x + 10, y + 18);
      });

      const link = document.createElement('a');
      const teamName = document.getElementById('teamName').value || 'Tim';
      link.download = `Desain_Rumah_Sakit_Lapangan_${teamName}.png`;
      link.href = tempCanvas.toDataURL();
      link.click();
      showNotification('Gambar desain didownload!');
    }

    // Send to Google Drive
    function sendToGoogleDrive() {
      showNotification('Untuk menyimpan ke Google Drive:');

      const instructions = `
Cara menyimpan ke Google Drive:

1. Ekspor sebagai PDF terlebih dahulu (klik tombol "üìÑ Ekspor sebagai PDF")

2. Buka Google Drive (drive.google.com)

3. Upload file PDF yang sudah didownload

Atau gunakan Google Drive app di HP untuk langsung upload dari folder Downloads.

      `;

      alert(instructions);
    }

    // Show notification
    function showNotification(message) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #10b981;
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        z-index: 1000;
        animation: fadeIn 0.3s ease;
      `;
      notification.textContent = message;
      document.body.appendChild(notification);

      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // Load saved data on page load
    window.addEventListener('load', loadFromLocalStorage);

    // Save canvas state before unload
    window.addEventListener('beforeunload', saveToLocalStorage);
  </script>
</body>
</html>
